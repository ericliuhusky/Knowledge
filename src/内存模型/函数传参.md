# 函数传参

## 基础类型

### 值传递

```swift
func f() {
    let a = 0
    f2(a: a)
}

func f2(a: Int) {

}
```

```rust
fn f() {
    let a = 0;
    f2(a);
}

fn f2(a: i32) {

}
```

```c
void f2(int a) {

}

void f() {
    int a = 0;
    f2(a);
}
```

```asm
// arm64, AT&T

_f:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // int a = 0;
    mov w8, #0
    str w8, [x29, #-4]

    // f2(a);
    ldr x0, [x29, #-4]
    bl _f2


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret

_f2:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret
```

### 地址/引用传递

```swift
func f() {
    var a = 0
    f2(a: &a)
}

func f2(a: inout Int) {
    a += 1
}
```

```rust
fn f() {
    let mut a = 0;
    f2(&mut a);
    println!("{}", a);
}

fn f2(a: &mut i32) {
    *a += 1;
}
```

```c
void f2(int *a) {
    *a += 1;
}

void f() {
    int a = 0;
    f2(&a);
}
```

```asm
// arm64, AT&T

_f:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // int a = 0;
    mov w8, #0
    str w8, [x29, #-4]

    // f2(&a);
    sub x0, x29, #4
    bl _f2


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret

_f2:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // *a += 1;
    ldr w8, [x0]
    add w8, w8, #1
    str w8, [x0]


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret
```

## 栈上复合类型

### 值传递

```swift
struct S {
    let a: Int
    let b: Int
    let c: Int
}

func f() {
    let s = S(a: 0, b: 0, c: 0)
    f2(s: s)
}

func f2(s: S) {

}
```

```rust
#[derive(Clone)]
struct S {
    a: i32,
    b: i32,
    c: i32,
}

fn f() {
    let s = S { a: 0, b: 0, c: 0 };
    f2(s.clone());
}

fn f2(s: S) {

}
```

```c
struct S {
    int a;
    int b;
    int c;
};

void f2(struct S s) {

}

void f() {
    struct S s = {0, 0, 0};
    f2(s);
}
```

```asm
// arm64, AT&T

_f:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // struct S s = {0, 0, 0};
    mov w8, #0
    str w8, [x29, #-4*3]
    mov w8, #0
    str w8, [x29, #-4*2]
    mov w8, #0
    str w8, [x29, #-4*1]

    // f2(s);
    ldr w8, [x29, #-4*3]
    str w8, [x29, #-4*6]
    ldr w8, [x29, #-4*2]
    str w8, [x29, #-4*5]
    ldr w8, [x29, #-4*1]
    str w8, [x29, #-4*4]

    sub x0, x29, #4*6
    bl _f2


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret

_f2:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret
```

### 地址/引用传递

```swift
struct S {
    let a: Int
    let b: Int
    let c: Int
}

func f() {
    var s = S(a: 0, b: 0, c: 0)
    f2(s: &s)
}

func f2(s: inout S) {
    s = S(a: 1, b: 1, c: 1)
}
```

```rust
struct S {
    a: i32,
    b: i32,
    c: i32,
}

fn f() {
    let mut s = S { a: 0, b: 0, c: 0 };
    f2(&mut s);
}

fn f2(s: &mut S) {
    *s = S { a: 1, b: 1, c: 1 };
}
```

```c
struct S {
    int a;
    int b;
    int c;
};

void f2(struct S *s) {
    s->a = 1;
    s->b = 1;
    s->c = 1;
}

void f() {
    struct S s = {0, 0, 0};
    f2(&s);
}
```

```asm
// arm64, AT&T

_f:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // struct S s = {0, 0, 0};
    mov w8, #0
    str w8, [x29, #-4*3]
    mov w8, #0
    str w8, [x29, #-4*2]
    mov w8, #0
    str w8, [x29, #-4*1]

    // f2(&s);
    sub x0, x29, #4*3
    bl _f2


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret

_f2:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // s->a = 1;
    mov w8, #1
    str w8, [x0]
    // s->b = 1;
    mov w8, #1
    str w8, [x0, #4]
    // s->c = 1;
    mov w8, #1
    str w8, [x0, #4*2]


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret
```

## 堆上复合类型

### 地址/引用传递

```swift
class C {
    var a: Int

    init(a: Int) {
        self.a = a
    }
}

func f() {
    let c = C(a: 0)
    f2(c: c)
}

func f2(c: C) {
    c.a += 1
}
```

```rust
struct C {
    a: i32,
}

fn f() {
    let mut c = Box::new(C { a: 0 });
    f2(&mut c);
}

fn f2(c: &mut Box<C>) {
    c.a += 1;
}
```

```c
struct C {
    int a;
};

void f2(struct C *c) {
    c->a += 1;
}

void f() {
    struct C *c = malloc(sizeof(struct C));
    c->a = 0;
    f2(c);
}
```

```asm
// arm64, AT&T

_f:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // struct C *c = malloc(sizeof(struct C));
    mov	x0, #4
    bl _malloc
    str x0, [x29, #-8]

    // c->a = 0;
    mov w8, #0
    ldr x9, [x29, #-8]
    str w8, [x9]

    // f2(c);
    ldr x0, [x29, #-8]
    bl _f2


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret

_f2:
    sub sp, sp, #64
    stp x29, x30, [sp, #48]
    add x29, sp, #48


    // c->a += 1;
    ldr w8, [x0]
    add w8, w8, #1
    str w8, [x0]


    ldp x29, x30, [sp, #48]
    add sp, sp, #64

    ret
```
